name: ci

permissions:
  contents: write

on:
  workflow_dispatch:   # 👈 手動觸發
  schedule:
    - cron: "1 1 * * 1-5"  # 每周一到周五 01:01 UTC 触发

jobs:
  autogreen:
    runs-on: ubuntu-latest
    steps:
      - name: Clone repository
        uses: actions/checkout@v4

      - name: Auto commit (3–5 times per week)
        env:
          TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
          USER_EMAIL: "geo.wang+ac@nyu.edu"
          USER_NAME: "GeoYWang"
        run: |
          git config --local user.email "${USER_EMAIL}"
          git config --local user.name "${USER_NAME}"
          git remote set-url origin https://x-access-token:${TOKEN}@github.com/${REPO}.git
          git pull --rebase

          WEEK_FILE=".week_plan"
          WEEK_NUM=$(date -u +%V)   # 当前周数 (ISO week number)

          # 如果文件不存在 或者 周数变化 -> 重新设定本周目标
          if [ ! -f $WEEK_FILE ] || [ "$(cut -d' ' -f1 $WEEK_FILE)" != "$WEEK_NUM" ]; then
            TARGET=$((3 + RANDOM % 3))   # 随机 3~5
            echo "$WEEK_NUM 0 $TARGET" > $WEEK_FILE
            echo "🎲 新的一周 (week $WEEK_NUM)，目标提交 $TARGET 次"
          fi

          CURRENT=$(cut -d' ' -f2 $WEEK_FILE)
          TARGET=$(cut -d' ' -f3 $WEEK_FILE)

          if [ "$CURRENT" -ge "$TARGET" ]; then
            echo "✅ 本周已完成 $CURRENT/$TARGET 次提交，今天休息"
          else
            # 剩余天数
            DAY_OF_WEEK=$(date -u +%u)   # 周几 (1=Mon ... 5=Fri)
            REMAIN=$((6 - DAY_OF_WEEK))
            LEFT=$((TARGET - CURRENT))

            # 策略：如果剩余天数 == 剩余提交数 -> 必须提交
            if [ "$LEFT" -ge "$REMAIN" ]; then
              DO_COMMIT=1
            else
              DO_COMMIT=$((RANDOM % 2))  # 50% 概率
            fi

            if [ "$DO_COMMIT" -eq 1 ]; then
              CURRENT=$((CURRENT + 1))
              echo "$WEEK_NUM $CURRENT $TARGET" > $WEEK_FILE
              git add $WEEK_FILE
              git commit -m "Auto commit $(date -u '+%Y-%m-%d %H:%M:%S UTC') [$CURRENT/$TARGET]"
              git push
              echo "📌 本周进度 $CURRENT/$TARGET，今天提交成功"
            else
              echo "😴 今天跳过 (进度 $CURRENT/$TARGET)"
            fi
          fi
